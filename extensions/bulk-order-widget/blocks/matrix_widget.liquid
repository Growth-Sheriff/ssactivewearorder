{% schema %}
{
  "name": "SSActive Bulk Order",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent/Success Color",
      "default": "#4CAF50"
    },
    {
      "type": "header",
      "content": "Features"
    },
    {
      "type": "checkbox",
      "id": "show_warehouse",
      "label": "Show Warehouse Details",
      "default": false,
      "info": "Display stock breakdown by warehouse location"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Add to Cart Button Text",
      "default": "Add Selected to Cart"
    },
    {
      "type": "text",
      "id": "widget_title",
      "label": "Widget Title",
      "default": "Bulk Order - Select Variants"
    }
  ]
}
{% endschema %}

<style>
/* Base Container */
.ss-bulk-order-widget {
  padding: 24px;
  border: 1px solid #e1e3e5;
  border-radius: 16px;
  margin: 24px 0;
  background: #ffffff;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.ss-bulk-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e1e3e5;
}

.ss-bulk-header h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: #1a1a1a;
}

/* Loading State */
.ss-loading {
  text-align: center;
  padding: 60px 20px;
  color: #637381;
}

.ss-loading-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 3px solid #e1e3e5;
  border-top-color: {{ block.settings.primary_color | default: '#000' }};
  border-radius: 50%;
  animation: ss-spin 0.8s linear infinite;
}

@keyframes ss-spin {
  to { transform: rotate(360deg); }
}

/* Section Titles */
.ss-section {
  margin-bottom: 24px;
}

.ss-section-title {
  font-size: 14px;
  font-weight: 600;
  color: #637381;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}

/* Color Grid - Variant Images */
.ss-color-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 12px;
}

.ss-color-card {
  cursor: pointer;
  border: 2px solid #e1e3e5;
  border-radius: 12px;
  padding: 8px;
  text-align: center;
  transition: all 0.2s ease;
  background: #fff;
}

.ss-color-card:hover {
  border-color: #999;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.ss-color-card.ss-color-selected {
  border-color: {{ block.settings.primary_color | default: '#000' }};
  box-shadow: 0 0 0 3px {{ block.settings.primary_color | default: '#000' }}20;
}

.ss-color-image {
  width: 100%;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  background: #f5f5f5;
  margin-bottom: 8px;
}

.ss-color-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.ss-no-image {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: #999;
}

.ss-color-name {
  font-size: 12px;
  font-weight: 500;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Sizes Section */
.ss-sizes-section {
  margin-bottom: 24px;
}

.ss-sizes-section.ss-hidden {
  display: none;
}

.ss-sizes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 12px;
}

.ss-size-card {
  background: #f8f9fa;
  border: 1px solid #e1e3e5;
  border-radius: 12px;
  padding: 16px 12px;
  text-align: center;
  transition: all 0.2s;
}

.ss-size-card:hover:not(.ss-size-out):not(.ss-size-unavailable) {
  background: #fff;
  border-color: {{ block.settings.primary_color | default: '#000' }};
}

.ss-size-card.ss-size-out {
  opacity: 0.5;
  background: #f5f5f5;
}

.ss-size-card.ss-size-unavailable {
  opacity: 0.3;
}

.ss-size-input {
  width: 100%;
  max-width: 70px;
  padding: 10px;
  border: 2px solid #e1e3e5;
  border-radius: 8px;
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  transition: all 0.2s;
  margin-bottom: 8px;
}

.ss-size-input:focus {
  outline: none;
  border-color: {{ block.settings.primary_color | default: '#000' }};
  box-shadow: 0 0 0 3px {{ block.settings.primary_color | default: '#000' }}15;
}

.ss-size-input.ss-disabled {
  background: #f0f0f0;
  cursor: not-allowed;
  color: #999;
}

.ss-size-name {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}

.ss-size-stock {
  font-size: 12px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 4px;
  display: inline-block;
}

.ss-size-stock.ss-stock-high { background: #E3F5E1; color: #1B7F1B; }
.ss-size-stock.ss-stock-medium { background: #FFF8E1; color: #B86E00; }
.ss-size-stock.ss-stock-low { background: #FFE5E5; color: #CC0000; }
.ss-size-stock.ss-stock-out { background: #f0f0f0; color: #999; }

.ss-size-price {
  font-size: 11px;
  color: #637381;
  margin-top: 4px;
}

.ss-warehouse-details {
  font-size: 10px;
  color: #999;
  margin-top: 4px;
}

/* Utility Classes */
.ss-hidden {
  display: none !important;
}

/* Upload Section */
.ss-upload-section {
  margin-top: 16px;
  margin-bottom: 8px;
}

.ss-upload-section-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e2e8f0;
}

/* Dynamic Upload Grid – 2 columns like the reference image */
.ss-upload-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
}

@media (max-width: 500px) {
  .ss-upload-grid {
    grid-template-columns: 1fr;
  }
}

.ss-upload-location {
  display: flex;
  flex-direction: column;
}

.ss-upload-area {
  position: relative;
  border: 2px solid #e2e8f0;
  border-radius: 16px;
  padding: 24px 16px 16px;
  text-align: center;
  cursor: pointer;
  transition: all 0.25s ease;
  background: #ffffff;
  min-height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.ss-upload-area:hover {
  border-color: {{ block.settings.primary_color | default: '#14b8a6' }};
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  transform: translateY(-2px);
}

.ss-upload-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.ss-tshirt-icon {
  background: #f1f5f9;
  border-radius: 12px;
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 4px;
  transition: transform 0.3s ease;
}

.ss-upload-area:hover .ss-tshirt-icon {
  transform: scale(1.08);
}

.ss-upload-loc-name {
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  letter-spacing: -0.01em;
}

.ss-upload-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  width: 100%;
  animation: ss-fade-in 0.3s ease;
}

@keyframes ss-fade-in {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}

.ss-upload-preview img {
  width: 100px;
  height: 100px;
  object-fit: contain;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
  background: white;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
}

.ss-upload-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.ss-upload-info span {
  font-size: 13px;
  font-weight: 600;
  color: #334155;
  max-width: 180px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ss-remove-design {
  background: #fee2e2;
  color: #dc2626;
  border: 1px solid #fecaca;
  border-radius: 8px;
  padding: 4px 12px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.ss-remove-design:hover {
  background: #dc2626;
  color: white;
}

.ss-upload-area.ss-upload-dragover {
  border-color: {{ block.settings.primary_color | default: '#14b8a6' }};
  background: #f0fdfa;
}

.ss-upload-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: #666;
}

.ss-upload-placeholder svg {
  color: #999;
}

.ss-upload-placeholder p {
  margin: 0;
  font-weight: 500;
}

.ss-upload-placeholder span {
  font-size: 12px;
  color: #999;
}

.ss-upload-preview {
  display: flex;
  align-items: center;
  gap: 16px;
}

.ss-upload-preview img {
  width: 80px;
  height: 80px;
  object-fit: contain;
  border-radius: 8px;
  border: 1px solid #e1e3e5;
  background: white;
}

.ss-upload-info {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
}

.ss-upload-info span {
  font-weight: 500;
  color: #333;
}

.ss-remove-design {
  background: none;
  border: 1px solid #EF4444;
  color: #EF4444;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.ss-remove-design:hover {
  background: #EF4444;
  color: white;
}

/* Order Summary */
.ss-order-summary {
  background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
}

.ss-summary-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.ss-summary-row:last-child {
  margin-bottom: 0;
}

.ss-summary-label {
  font-size: 14px;
  color: #637381;
}

.ss-summary-value {
  font-size: 18px;
  font-weight: 700;
  color: {{ block.settings.primary_color | default: '#000' }};
}

.ss-total-price {
  font-size: 24px;
}

/* Add to Cart Button */
.ss-add-to-cart-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 16px 24px;
  background: {{ block.settings.primary_color | default: '#000' }};
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.ss-add-to-cart-btn:hover:not(:disabled) {
  opacity: 0.9;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px {{ block.settings.primary_color | default: '#000' }}40;
}

.ss-add-to-cart-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.ss-btn-spinner {
  display: inline-block;
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: ss-spin 0.6s linear infinite;
}

/* Toast Notifications */
.ss-toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 24px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  z-index: 10000;
  animation: ss-toast-in 0.3s ease;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.ss-toast-success {
  background: {{ block.settings.accent_color | default: '#4CAF50' }};
  color: white;
}

.ss-toast-error {
  background: #EF4444;
  color: white;
}

@keyframes ss-toast-in {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* Error State */
.ss-error {
  background: #FEF2F2;
  border: 1px solid #FECACA;
  border-radius: 8px;
  padding: 16px;
  color: #991B1B;
  text-align: center;
}

.ss-error p {
  margin: 0;
}

/* Responsive */
@media (max-width: 600px) {
  .ss-bulk-order-widget {
    padding: 16px;
    margin: 16px 0;
  }

  .ss-color-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }

  .ss-color-card {
    padding: 6px;
  }

  .ss-color-name {
    font-size: 10px;
  }

  .ss-sizes-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .ss-size-card {
    padding: 12px 8px;
  }

  .ss-size-input {
    padding: 8px;
    font-size: 14px;
  }
}
</style>

<div class="ss-bulk-order-widget"
     id="ss-matrix-widget-{{ block.id }}"
     data-variants='{{ product.variants | json | escape }}'
     data-product-id="{{ product.id }}"
     data-show-warehouse="{{ block.settings.show_warehouse }}"
     data-button-text="{{ block.settings.button_text }}">

  <div class="ss-bulk-header">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="{{ block.settings.primary_color | default: '#000' }}" stroke-width="2">
      <rect x="1" y="3" width="15" height="13"></rect>
      <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
      <circle cx="5.5" cy="18.5" r="2.5"></circle>
      <circle cx="18.5" cy="18.5" r="2.5"></circle>
    </svg>
    <h3>{{ block.settings.widget_title }}</h3>
  </div>

  <div class="ss-loading" id="ss-loading-{{ block.id }}">
    <div class="ss-loading-spinner"></div>
    <p style="margin-top: 12px;">Loading inventory...</p>
  </div>

  <div class="ss-content" id="ss-content-{{ block.id }}" style="display: none;">
    <!-- Variant selection rendered by JS -->
  </div>

  <!-- Dynamic Upload Locations – reads from PRODUCT metafield (set per product in merchant panel) -->
  {%- assign upload_locations = product.metafields.ss_custom.upload_locations.value -%}
  {%- if upload_locations == blank -%}
    {%- comment -%}Fallback: try shop-level, then default{%- endcomment -%}
    {%- assign upload_locations = shop.metafields.ss_custom.upload_locations.value -%}
  {%- endif -%}

  {%- if upload_locations != blank and upload_locations.size > 0 -%}
  <div class="ss-upload-section" id="ss-upload-{{ block.id }}" style="display: none;">
    <div class="ss-upload-section-header">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m4-5l5-5 5 5m-5-5v12"></path></svg>
      <span>Upload Your Designs</span>
    </div>
    <div class="ss-upload-grid">
      {% for location in upload_locations %}
        <div class="ss-upload-location" data-location-name="{{ location.name }}">
          <div class="ss-upload-area" id="upload-area-{{ location.name }}-{{ block.id }}" onclick="document.getElementById('file-input-{{ location.name }}-{{ block.id }}').click()">
            <!-- T-shirt Icon with highlighted print zone -->
            <div class="ss-upload-placeholder" id="placeholder-{{ location.name }}-{{ block.id }}">
              <div class="ss-tshirt-icon">
                <svg width="64" height="64" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M30 25 L20 30 L10 45 L22 50 L25 40 L25 85 L75 85 L75 40 L78 50 L90 45 L80 30 L70 25 L62 20 L38 20 L30 25Z"
                        fill="#f1f5f9" stroke="#94a3b8" stroke-width="2" stroke-linejoin="round"/>
                  <path d="M38 20 Q50 28 62 20" fill="none" stroke="#94a3b8" stroke-width="2"/>
                  {% case location.icon %}
                    {% when 'full_front' %}
                      <rect x="30" y="35" width="40" height="40" rx="4" fill="#5eead4" fill-opacity="0.5" stroke="#14b8a6" stroke-width="1.5"/>
                    {% when 'full_back' %}
                      <rect x="30" y="35" width="40" height="40" rx="4" fill="#818cf8" fill-opacity="0.5" stroke="#6366f1" stroke-width="1.5"/>
                      <line x1="40" y1="45" x2="60" y2="45" stroke="#6366f1" stroke-width="1" stroke-dasharray="3 2"/>
                      <line x1="40" y1="55" x2="60" y2="55" stroke="#6366f1" stroke-width="1" stroke-dasharray="3 2"/>
                    {% when 'left_chest' %}
                      <rect x="30" y="35" width="16" height="14" rx="3" fill="#5eead4" fill-opacity="0.6" stroke="#14b8a6" stroke-width="1.5"/>
                    {% when 'right_chest' %}
                      <rect x="54" y="35" width="16" height="14" rx="3" fill="#fb923c" fill-opacity="0.5" stroke="#f97316" stroke-width="1.5"/>
                    {% when 'left_sleeve' %}
                      <rect x="12" y="32" width="14" height="12" rx="3" fill="#a78bfa" fill-opacity="0.5" stroke="#8b5cf6" stroke-width="1.5" transform="rotate(-15 19 38)"/>
                    {% when 'right_sleeve' %}
                      <rect x="74" y="32" width="14" height="12" rx="3" fill="#f472b6" fill-opacity="0.5" stroke="#ec4899" stroke-width="1.5" transform="rotate(15 81 38)"/>
                    {% else %}
                      <rect x="35" y="40" width="30" height="30" rx="4" fill="#94a3b8" fill-opacity="0.3" stroke="#94a3b8" stroke-width="1.5"/>
                  {% endcase %}
                </svg>
              </div>
              <p class="ss-upload-loc-name">{{ location.label }}</p>
            </div>

            <div class="ss-upload-preview ss-hidden" id="preview-{{ location.name }}-{{ block.id }}">
              <img src="" alt="Preview">
              <div class="ss-upload-info">
                <span id="filename-{{ location.name }}-{{ block.id }}"></span>
                <button type="button" class="ss-remove-design" onclick="event.stopPropagation(); window.removeUpload('{{ location.name }}', '{{ block.id }}')">Remove</button>
              </div>
            </div>

            <input type="file"
                   id="file-input-{{ location.name }}-{{ block.id }}"
                   class="ss-hidden"
                   accept="image/*"
                   style="display: none;"
                   onchange="window.handleFileUpload(this, '{{ location.name }}', '{{ block.id }}')">
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {%- endif -%}


  <div class="ss-footer" id="ss-footer-{{ block.id }}" style="display: none;">
    <!-- Summary and Footer rendered by JS -->
  </div>

  <div class="ss-error" id="ss-error-{{ block.id }}" style="display: none;">
    <!-- Error rendered by JS -->
  </div>
</div>

{{ 'matrix.js' | asset_url | script_tag }}

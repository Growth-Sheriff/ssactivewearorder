// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Session {
  id                  String    @id
  shop                String
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?
}

model ProductMap {
  id               String       @id @default(uuid())
  shop             String       @default("")
  shopifyProductId String       @unique
  ssStyleId        String
  variants         VariantMap[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model VariantMap {
  id               String     @id @default(uuid())
  shopifyVariantId String     @unique
  ssSku            String
  productMapId     String
  product          ProductMap @relation(fields: [productMapId], references: [id])
}

model OrderJob {
  id             String   @id @default(uuid())
  shop           String   @default("")
  shopifyOrderId String
  shopifyOrderNumber String?
  status         String   // pending, submitted, shipped, error
  ssOrderNumber  String?
  ssOrderGuid    String?
  logs           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// SSActiveWear Catalog Cache
model SSBrand {
  id            String    @id @default(uuid())
  brandId       Int       @unique
  name          String
  image         String?
  noeRetailing  Boolean   @default(false)
  stylesCount   Int       @default(0)
  updatedAt     DateTime  @updatedAt
}

model SSCategory {
  id          String   @id @default(uuid())
  categoryId  Int      @unique
  name        String
  parentId    Int?
  stylesCount Int      @default(0)
  updatedAt   DateTime @updatedAt
}

model SSStyleCache {
  id              String   @id @default(uuid())
  styleId         Int      @unique
  partNumber      String
  brandId         Int
  brandName       String
  styleName       String
  title           String
  description     String?
  baseCategory    String
  categories      String   // comma separated category IDs
  styleImage      String?
  basePrice       Float    @default(0) // Added for bulk price
  sustainableStyle Boolean @default(false)
  productCount    Int      @default(0)
  updatedAt       DateTime @updatedAt
}

model CatalogSyncLog {
  id         String   @id @default(uuid())
  syncType   String   // brands, categories, styles
  status     String   // running, completed, failed
  itemsCount Int      @default(0)
  error      String?
  startedAt  DateTime @default(now())
  completedAt DateTime?
}

// ===== NEW FEATURES =====

// 1. Analytics & Dashboard Stats
model DailyStats {
  id             String   @id @default(uuid())
  shop           String
  date           DateTime
  ordersCount    Int      @default(0)
  itemsSold      Int      @default(0)
  revenue        Float    @default(0)
  ssOrdersCount  Int      @default(0)
  importedCount  Int      @default(0)
  createdAt      DateTime @default(now())

  @@unique([shop, date])
}

// 2. Price Markup Rules
model PriceRule {
  id              String   @id @default(uuid())
  shop            String
  name            String
  type            String   // percentage, fixed, formula
  value           Float    // markup percentage or fixed amount
  applyTo         String   // all, brand, category
  applyToValue    String?  // brand name or category id if not "all"
  roundTo         Float    @default(0.99) // round to .99
  minMargin       Float    @default(0) // minimum margin percentage
  isActive        Boolean  @default(true)
  priority        Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 3. Favorites/Watchlist
model Favorite {
  id         String   @id @default(uuid())
  shop       String
  styleId    Int
  partNumber String
  brandName  String
  styleName  String
  styleImage String?
  notes      String?
  tags       String?  // comma-separated custom tags
  createdAt  DateTime @default(now())

  @@unique([shop, styleId])
}

// 4. Stock Alerts
model StockAlert {
  id           String   @id @default(uuid())
  shop         String
  sku          String
  productTitle String
  variantTitle String
  threshold    Int      @default(10)
  currentStock Int      @default(0)
  lastChecked  DateTime?
  isTriggered  Boolean  @default(false)
  notifiedAt   DateTime?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([shop, sku])
}

// 5. Import Queue for Bulk Import
model ImportQueue {
  id         String   @id @default(uuid())
  shop       String
  styleId    Int
  status     String   @default("pending") // pending, processing, completed, failed
  error      String?
  priceRuleId String?
  tags       String?   // tags to apply
  collection String?   // collection handle to add to
  createdAt  DateTime @default(now())
  processedAt DateTime?
}

// 6. Auto Order Settings
model AutoOrderSettings {
  id                  String   @id @default(uuid())
  shop                String   @unique
  isEnabled           Boolean  @default(false)
  autoSubmit          Boolean  @default(false) // auto-submit to SS or require approval
  defaultShippingMethod String  @default("FXG")
  notifyEmail         String?
  minOrderValue       Float    @default(0)
  excludeTags         String?  // orders with these tags won't auto-process
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// 7. Shipment Tracking
model ShipmentTracking {
  id             String   @id @default(uuid())
  shop           String
  orderJobId     String
  carrier        String?
  trackingNumber String?
  trackingUrl    String?
  status         String   @default("pending") // pending, in_transit, delivered
  estimatedDelivery DateTime?
  lastUpdate     DateTime?
  events         String?  // JSON array of tracking events
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// 8. Quick Reorder Templates
model ReorderTemplate {
  id         String   @id @default(uuid())
  shop       String
  name       String
  items      String   // JSON array of {sku, qty}
  totalItems Int      @default(0)
  lastUsed   DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ===== OPERATIONAL FEATURES =====

// 9. Webhook Logs
model WebhookLog {
  id           String   @id @default(uuid())
  shop         String
  topic        String   // orders/create, products/update, etc
  direction    String   // incoming, outgoing
  endpoint     String?  // URL called or received from
  method       String   @default("POST")
  requestBody  String?  // JSON
  responseBody String?  // JSON
  statusCode   Int?
  duration     Int?     // ms
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())

  @@index([shop, createdAt])
  @@index([topic])
}

// 10. API Rate Limit Tracking
model ApiRateLimit {
  id            String   @id @default(uuid())
  shop          String
  apiName       String   // ssactivewear, shopify
  endpoint      String   // /products, /orders
  requestCount  Int      @default(0)
  limitMax      Int      @default(100)
  windowStart   DateTime
  windowEnd     DateTime
  lastRequest   DateTime?
  isThrottled   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([shop, apiName, endpoint, windowStart])
  @@index([shop, apiName])
}

// 11. Scheduled Sync Jobs
model ScheduledJob {
  id            String   @id @default(uuid())
  shop          String
  jobType       String   // catalog_sync, inventory_sync, price_update
  schedule      String   // cron expression or 'hourly', 'daily', 'weekly'
  isEnabled     Boolean  @default(true)
  lastRunAt     DateTime?
  nextRunAt     DateTime?
  lastStatus    String?  // success, failed, running
  lastError     String?
  runCount      Int      @default(0)
  config        String?  // JSON configuration
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([shop, jobType])
}

// 12. Activity Log (Audit Trail)
model ActivityLog {
  id          String   @id @default(uuid())
  shop        String
  userId      String?  // staff member ID if applicable
  userEmail   String?
  action      String   // product_imported, order_submitted, settings_changed
  resource    String   // product, order, setting
  resourceId  String?
  details     String?  // JSON with additional context
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([shop, createdAt])
  @@index([action])
  @@index([resourceId])
}

// 13. User Roles & Staff
model StaffMember {
  id          String   @id @default(uuid())
  shop        String
  email       String
  name        String?
  role        String   @default("viewer") // admin, manager, viewer
  permissions String?  // JSON array of specific permissions
  isActive    Boolean  @default(true)
  lastLogin   DateTime?
  invitedAt   DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([shop, email])
}

// ===== CUSTOMER FEATURES =====

// 14. Stock Notifications (Notify when back in stock)
model StockNotification {
  id          String   @id @default(uuid())
  shop        String
  email       String
  sku         String
  productId   String?  // Shopify product ID
  variantId   String?  // Shopify variant ID
  styleId     Int?     // SS style ID
  styleName   String?
  colorName   String?
  sizeName    String?
  isNotified  Boolean  @default(false)
  notifiedAt  DateTime?
  createdAt   DateTime @default(now())

  @@index([shop, sku])
  @@index([email])
}

// 15. Inventory Sync Log
model InventorySyncLog {
  id            String   @id @default(uuid())
  shop          String
  syncType      String   // full, incremental
  status        String   // running, completed, failed
  productsTotal Int      @default(0)
  productsUpdated Int    @default(0)
  productsFailed Int     @default(0)
  errors        String?  // JSON array of errors
  startedAt     DateTime @default(now())
  completedAt   DateTime?
}

// 16. Size Charts
model SizeChart {
  id          String   @id @default(uuid())
  brand       String   // Brand name
  category    String?  // Shirt, Pants, etc
  chartData   String   // JSON with size measurements
  unit        String   @default("inches") // inches, cm
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([brand, category])
}

// 17. Customer Order Tracking (public tracking page data)
model CustomerTracking {
  id              String   @id @default(uuid())
  shop            String
  shopifyOrderId  String
  orderNumber     String
  customerEmail   String
  trackingToken   String   @unique // unique token for public access
  carrier         String?
  trackingNumber  String?
  status          String   @default("processing") // processing, shipped, in_transit, delivered
  events          String?  // JSON array of tracking events
  estimatedDelivery DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shop, shopifyOrderId])
  @@index([customerEmail])
}

// 20. Upload Locations (Global defaults per shop)
model UploadLocation {
  id           String   @id @default(uuid())
  shop         String
  name         String   // Machine name: 'front'
  label        String   // Display name: 'Front'
  iconType     String   @default("custom") // full_front, full_back, left_chest, right_chest, left_sleeve, right_sleeve, custom
  sortOrder    Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([shop])
}

// 21. Product-specific Upload Locations
model ProductUploadLocation {
  id                String   @id @default(uuid())
  shop              String
  shopifyProductId  String
  name              String   // Machine name: 'full_front'
  label             String   // Display name: 'Full Front'
  iconType          String   @default("full_front")
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([shop, shopifyProductId])
  @@unique([shopifyProductId, name])
}

// ═══════════════════════════════════════════════════════
// 22. Volume Price Rules (Quantity-based discount system)
// ═══════════════════════════════════════════════════════

model VolumePriceRule {
  id              String   @id @default(uuid())
  shop            String
  name            String                             // "Unisex Adult Crewneck", "Premium Hoodie"
  description     String?                            // Optional description
  isActive        Boolean  @default(true)
  syncEnabled     Boolean  @default(true)            // Auto-sync prices from SSActiveWear
  syncIntervalDays Int     @default(3)               // Sync every N days
  lastSyncAt      DateTime?
  tiers           VolumeTier[]
  sizePremiums    VolumeSizePremium[]
  products        VolumePriceProduct[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([shop])
}

model VolumeTier {
  id              String   @id @default(uuid())
  ruleId          String
  rule            VolumePriceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  minQty          Int                                // Minimum quantity (e.g. 1, 12, 25)
  maxQty          Int?                               // Maximum quantity (null = unlimited)
  discountType    String   @default("percentage")    // "percentage" or "fixed"
  discountValue   Float                              // 10 means 10% or $10 based on type
  sortOrder       Int      @default(0)

  @@index([ruleId])
}

model VolumeSizePremium {
  id              String   @id @default(uuid())
  ruleId          String
  rule            VolumePriceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  sizePattern     String                             // "2XL", "3XL", "4XL", "2XL-3XL"
  premiumType     String   @default("fixed")         // "fixed" or "percentage"
  premiumValue    Float                              // $1.71 extra or 5% extra
  sortOrder       Int      @default(0)

  @@index([ruleId])
}

model VolumePriceProduct {
  id              String   @id @default(uuid())
  ruleId          String
  rule            VolumePriceRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  shopifyProductId String                            // Shopify product GID
  ssStyleId       String                             // SSActiveWear style ID
  basePrice       Float    @default(0)               // Base cost from SSActiveWear
  styleName       String?                            // Cached style name for display
  lastPriceSync   DateTime?

  @@unique([ruleId, shopifyProductId])
  @@index([ruleId])
  @@index([shopifyProductId])
}

model LeadCapture {
  id            String   @id @default(uuid())
  email         String
  productId     String   @default("")
  productTitle  String   @default("")
  orderDetails  String   @default("[]")           // JSON array of {variantId, size, qty}
  totalQuantity Int      @default(0)
  pageUrl       String   @default("")
  status        String   @default("new")           // new, contacted, converted, closed
  source        String   @default("bulk-order-widget")
  notes         String   @default("")              // Merchant notes
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

// ═══════════════════════════════════════════════════════
// Reorder Cart (persisted cart for quick-reorder page)
// ═══════════════════════════════════════════════════════
model ReorderCart {
  id        String   @id @default(uuid())
  shop      String
  items     String   @default("[]")   // JSON array of CartItem
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shop])
}
